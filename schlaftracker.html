<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schlaf-Stoppuhr</title>
  <style>
    /* === Dein CSS === */
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071028 0%, #071831 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{background:var(--card);padding:28px;border-radius:16px;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 12px;font-size:20px}
    p.lead{margin:0 0 20px;color:var(--muted)}
    .timer{font-weight:700;font-size:56px;letter-spacing:0.02em;margin:14px 0;text-align:center}
    .controls{display:flex;gap:12px;justify-content:center;margin-top:10px}
    button{padding:14px 20px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
    .btn-start{background:linear-gradient(90deg,var(--accent),#0ea5a4);color:#022;box-shadow:0 8px 20px rgba(6,182,212,0.12)}
    .btn-stop{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06)}
    .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;margin-top:16px}
    .small{font-size:12px;color:var(--muted);text-align:center;margin-top:14px}
    .indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
    .on{background:#10b981;box-shadow:0 6px 18px rgba(16,185,129,0.12)}
    .off{background:#334155}
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>Schlaf‑Stoppuhr</h1>
    <p class="lead">Drücke den Knopf, wenn du schlafen gehst. Die Stoppuhr läuft, bis du den Knopf wieder drückst.</p>

    <div style="display:flex;align-items:center;justify-content:center;gap:12px;">
      <span class="indicator off" id="indicator" aria-hidden="true"></span>
      <div style="text-align:left;">
        <div id="statusText" style="font-weight:700">Nicht aktiv</div>
        <div style="font-size:13px;color:var(--muted)" id="sinceText">—</div>
      </div>
    </div>

    <div class="timer" id="timer">00:00:00</div>

    <div class="controls">
      <button id="toggleBtn" class="btn-start" aria-pressed="false">Schlafen — Start</button>
      <button id="resetBtn" class="btn-stop">Zurücksetzen</button>
    </div>

    <div class="meta">
      <div>Gesamtdauer</div>
      <div id="totalText">—</div>
    </div>

    <div class="small">Die Seite merkt sich den Laufstatus im Browser (localStorage). Beim Neuladen bleibt die Uhr aktiv.</div>
  </main>

  <!-- ================= Firebase SDK ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD4q23o9Q2XFtqxHasWlVWqzdYO-_9Ols",
      authDomain: "schlafstatus.firebaseapp.com",
      databaseURL: "https://schlafstatus-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "schlafstatus",
      storageBucket: "schlafstatus.firebasestorage.app",
      messagingSenderId: "934153337996",
      appId: "1:934153337996:web:87c22a77a6e3b36b268fa9",
      measurementId: "G-1CBJZJ6XN3"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
  </script>

  <!-- ================= Timer / Stoppuhr ================= -->
  <script>
    const timerEl = document.getElementById('timer');
    const toggleBtn = document.getElementById('toggleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const indicator = document.getElementById('indicator');
    const statusText = document.getElementById('statusText');
    const sinceText = document.getElementById('sinceText');
    const totalText = document.getElementById('totalText');

    let rafId = null;

    function nowMs(){return Date.now();}
    function formatHMS(ms){
      if(ms<0)ms=0;
      const totalSec = Math.floor(ms/1000);
      const h = Math.floor(totalSec/3600);
      const m = Math.floor((totalSec%3600)/60);
      const s = totalSec%60;
      return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }

    // ===== Load & Save State im localStorage =====
    const KEY_ACTIVE = 'sleep_stopwatch_active';
    const KEY_START = 'sleep_stopwatch_start';
    const KEY_ACCUM = 'sleep_stopwatch_accum';

    function loadState(){
      const active = localStorage.getItem(KEY_ACTIVE) === '1';
      const start = parseInt(localStorage.getItem(KEY_START)||'0',10)||0;
      const accum = parseInt(localStorage.getItem(KEY_ACCUM)||'0',10)||0;
      return {active,start,accum};
    }

    function saveState({active,start,accum}){
      localStorage.setItem(KEY_ACTIVE,active?'1':'0');
      localStorage.setItem(KEY_START,String(start||0));
      localStorage.setItem(KEY_ACCUM,String(accum||0));
    }

    function updateUI(active,start,accum){
      if(active){
        indicator.classList.remove('off'); indicator.classList.add('on');
        statusText.textContent = 'Stoppuhr läuft';
        sinceText.textContent = 'Gestartet: '+new Date(start).toLocaleString();
        toggleBtn.textContent = 'Aufgewacht — Stop';
        toggleBtn.setAttribute('aria-pressed','true');
        toggleBtn.classList.remove('btn-start'); toggleBtn.classList.add('btn-stop');
      } else {
        indicator.classList.remove('on'); indicator.classList.add('off');
        statusText.textContent = 'Nicht aktiv';
        sinceText.textContent = accum?'Letzte Session: '+formatHMS(accum):'—';
        toggleBtn.textContent = 'Schlafen — Start';
        toggleBtn.setAttribute('aria-pressed','false');
        toggleBtn.classList.remove('btn-stop'); toggleBtn.classList.add('btn-start');
      }
      totalText.textContent = formatHMS(accum+(active?(nowMs()-start):0));
    }

    function tick(){
      const {active,start,accum} = loadState();
      const elapsed = accum + (active?(nowMs()-start):0);
      timerEl.textContent = formatHMS(elapsed);
      totalText.textContent = formatHMS(elapsed);
      rafId = requestAnimationFrame(tick);
    }

    toggleBtn.addEventListener('click', ()=>{
      let {active,start,accum} = loadState();
      if(!active){
        start=nowMs(); active=true;
      } else {
        const delta = nowMs()-start;
        accum=(accum||0)+delta;
        start=0; active=false;
      }
      saveState({active,start,accum});
      updateUI(active,start,accum);
      // TODO: Firebase schreiben, damit Freunde live sehen können
    });

    resetBtn.addEventListener('click', ()=>{
      if(!confirm('Willst du die Stoppuhr wirklich zurücksetzen?')) return;
      saveState({active:false,start:0,accum:0});
      updateUI(false,0,0);
      timerEl.textContent='00:00:00';
    });

    (function(){
      const state=loadState();
      if(state.active&&!state.start){state.active=false; state.start=0; saveState(state);}
      updateUI(state.active,state.start,state.accum);
      if(rafId) cancelAnimationFrame(rafId);
      tick();
    })();
  </script>
</body>
</html>

